{% extends 'glossymatcha/base.html' %}
{% load money_filters %}

{% block title %}대시보드 - Glossy Matcha{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2 class="mb-0">
            <i class="bi bi-house-door me-2"></i>매장 운영 대시보드
        </h2>
        <p class="text-muted">오늘의 매장 운영 현황을 한눈에 확인하세요</p>
    </div>
</div>

<!-- 요약 통계 카드 -->
<div class="row mb-4">
    <div class="col-xl-2 col-md-4 mb-3">
        <div class="card dashboard-card h-100">
            <div class="card-body text-center">
                <i class="bi bi-people dashboard-icon mb-3"></i>
                <h5 class="card-title">재직 직원</h5>
                <div class="stat-number">{{ active_staff_count }}명</div>
                <small class="text-muted">현재 재직 중인 직원 수</small>
            </div>
        </div>
    </div>
    
    <div class="col-xl-2 col-md-4 mb-3">
        <div class="card dashboard-card h-100">
            <div class="card-body text-center">
                <i class="bi bi-calendar-day dashboard-icon mb-3"></i>
                <h5 class="card-title">오늘 매출</h5>
                <div class="stat-number">{{ today_sales|korean_won_with_unit|default:"0원" }}</div>
                <small class="text-muted">{{ today|date:"m월 d일" }} 매출액</small>
            </div>
        </div>
    </div>
    
    <div class="col-xl-2 col-md-4 mb-3">
        <div class="card dashboard-card h-100">
            <div class="card-body text-center">
                <i class="bi bi-graph-up dashboard-icon mb-3"></i>
                <h5 class="card-title">이번 달 매출</h5>
                <div class="stat-number">{{ monthly_sales|korean_won_with_unit|default:"0원" }}</div>
                <small class="text-muted">{{ today|date:"Y년 m월" }} 누적 매출</small>
            </div>
        </div>
    </div>
    
    <div class="col-xl-2 col-md-4 mb-3">
        <div class="card dashboard-card h-100">
            <div class="card-body text-center">
                <i class="bi bi-shop dashboard-icon mb-3"></i>
                <h5 class="card-title">거래처</h5>
                <div class="stat-number">{{ active_suppliers_count }}개</div>
                <small class="text-muted">활성 거래처 수</small>
            </div>
        </div>
    </div>
    
    <div class="col-xl-2 col-md-4 mb-3">
        <div class="card dashboard-card h-100">
            <div class="card-body text-center">
                <i class="bi bi-chat-left dashboard-icon mb-3"></i>
                <h5 class="card-title">고객 문의</h5>
                <div class="stat-number">{{ total_inquiries|default:"0" }}건</div>
                <small class="text-muted">총 접수된 문의</small>
            </div>
        </div>
    </div>
</div>

<!-- 빠른 액션 버튼 -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-lightning me-2"></i>빠른 작업</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-lg-2 col-md-4 mb-2">
                        <a href="{% url 'staff_create' %}" class="btn btn-outline-primary w-100">
                            <i class="bi bi-person-plus me-2"></i>직원 등록
                        </a>
                    </div>
                    <div class="col-lg-2 col-md-4 mb-2">
                        <a href="{% url 'daily_sales_create' %}" class="btn btn-outline-primary w-100">
                            <i class="bi bi-calendar-day me-2"></i>일별 매출
                        </a>
                    </div>
                    <div class="col-lg-2 col-md-4 mb-2">
                        <a href="{% url 'sales_create' %}" class="btn btn-outline-primary w-100">
                            <i class="bi bi-calendar3 me-2"></i>월별 매출
                        </a>
                    </div>
                    <div class="col-lg-2 col-md-4 mb-2">
                        <a href="{% url 'yearly_sales_create' %}" class="btn btn-outline-primary w-100">
                            <i class="bi bi-bar-chart me-2"></i>연별 매출
                        </a>
                    </div>
                    <div class="col-lg-2 col-md-4 mb-2">
                        <a href="{% url 'suppliers_create' %}" class="btn btn-outline-primary w-100">
                            <i class="bi bi-shop-window me-2"></i>거래처 등록
                        </a>
                    </div>
                    <div class="col-lg-2 col-md-4 mb-2">
                        <a href="#" class="btn btn-outline-primary w-100" data-bs-toggle="modal" data-bs-target="#workRecordModal">
                            <i class="bi bi-cash me-2"></i>급여 기록
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 매출 분석 대시보드 -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-graph-up-arrow me-2"></i>매출 분석</h5>
                <div>
                    <a href="{% url 'monthly_sales_excel_export' %}" class="btn btn-sm btn-outline-success me-2">
                        <i class="bi bi-file-earmark-excel me-1"></i>월간 매출 현황
                    </a>
                    <a href="{% url 'yearly_sales_excel_export' %}" class="btn btn-sm btn-outline-success">
                        <i class="bi bi-file-earmark-excel me-1"></i>연간 매출 현황
                    </a>
                </div>
            </div>
            <div class="card-body">
                <!-- 매출 지표 -->
                <div class="row mb-4">
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6 class="card-title">전월 대비</h6>
                                <div class="h4 {% if sales_analysis.mom_change >= 0 %}text-success{% else %}text-danger{% endif %}">
                                    {% if sales_analysis.mom_change >= 0 %}↑{% else %}↓{% endif %} {{ sales_analysis.mom_change|floatformat:1 }}%
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6 class="card-title">전년 동월 대비</h6>
                                <div class="h4 {% if sales_analysis.yoy_change >= 0 %}text-success{% else %}text-danger{% endif %}">
                                    {% if sales_analysis.yoy_change >= 0 %}↑{% else %}↓{% endif %} {{ sales_analysis.yoy_change|floatformat:1 }}%
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6 class="card-title">수익률</h6>
                                <div class="h4 text-primary">{{ sales_analysis.profit_margin|floatformat:1 }}%</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6 class="card-title">원가율</h6>
                                <div class="h4 text-info">{{ sales_analysis.cost_ratio|floatformat:1 }}%</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 차트 영역 -->
                <div class="row">
                    <div class="col-lg-8 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <ul class="nav nav-tabs card-header-tabs" role="tablist">
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link active" id="monthly-tab" data-bs-toggle="tab" data-bs-target="#monthly-chart" type="button" role="tab">
                                            월별 매출 트렌드
                                        </button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="daily-tab" data-bs-toggle="tab" data-bs-target="#daily-chart" type="button" role="tab">
                                            최근 30일 매출
                                        </button>
                                    </li>
                                </ul>
                            </div>
                            <div class="card-body">
                                <div class="tab-content">
                                    <div class="tab-pane fade show active" id="monthly-chart" role="tabpanel">
                                        <canvas id="monthlyChart" height="100"></canvas>
                                    </div>
                                    <div class="tab-pane fade" id="daily-chart" role="tabpanel">
                                        <canvas id="dailyChart" height="100"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">매출 구성</h6>
                            </div>
                            <div class="card-body">
                                <canvas id="salesCompositionChart" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 최근 활동 -->
<div class="row">
    <div class="col-md-4 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>최근 매출 현황</h5>
            </div>
            <div class="card-body">
                {% if recent_sales %}
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>날짜</th>
                                    <th>분류</th>
                                    <th class="text-end">금액</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for sale in recent_sales %}
                                <tr>
                                    <td>{{ sale.date|date:"m.d" }}</td>
                                    <td>
                                        <span class="badge bg-primary">일별</span>
                                    </td>
                                    <td class="text-end">{{ sale.total_sales|korean_won_with_unit }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="text-center">
                        <a href="{% url 'daily_sales_list' %}" class="btn btn-sm btn-outline-primary">
                            전체 일별 매출 보기 <i class="bi bi-arrow-right"></i>
                        </a>
                    </div>
                {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-graph-up" style="font-size: 2rem;"></i>
                        <p class="mt-2">등록된 일별 매출 데이터가 없습니다.</p>
                        <a href="{% url 'daily_sales_create' %}" class="btn btn-sm btn-primary">첫 일별 매출 입력하기</a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-4 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-people me-2"></i>직원 현황</h5>
            </div>
            <div class="card-body">
                {% if staff_list %}
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>이름</th>
                                    <th>구분</th>
                                    <th>입사일</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for staff in staff_list %}
                                <tr>
                                    <td>{{ staff.name }}</td>
                                    <td>
                                        <span class="badge {% if staff.employee_type == 'full_time' %}bg-primary{% else %}bg-success{% endif %}">
                                            {{ staff.get_employee_type_display }}
                                        </span>
                                    </td>
                                    <td>{{ staff.hire_date|date:"Y.m.d" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="text-center">
                        <a href="{% url 'staff_list' %}" class="btn btn-sm btn-outline-primary">
                            전체 직원 보기 <i class="bi bi-arrow-right"></i>
                        </a>
                    </div>
                {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-people" style="font-size: 2rem;"></i>
                        <p class="mt-2">등록된 직원이 없습니다.</p>
                        <a href="{% url 'staff_create' %}" class="btn btn-sm btn-primary">첫 직원 등록하기</a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-4 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-chat-left me-2"></i>최근 고객 문의</h5>
            </div>
            <div class="card-body">
                {% if recent_inquiries %}
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>문의자</th>
                                    <th>유형</th>
                                    <th>문의일</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for inquiry in recent_inquiries %}
                                <tr>
                                    <td>
                                        <a href="{% url 'inquiries_detail' inquiry.pk %}" class="text-decoration-none">
                                            {{ inquiry.name }}
                                        </a>
                                    </td>
                                    <td>
                                        <span class="badge 
                                            {% if inquiry.inquiry_type == 'general' %}bg-primary
                                            {% elif inquiry.inquiry_type == 'product' %}bg-success
                                            {% else %}bg-secondary{% endif %} badge-sm">
                                            {{ inquiry.get_inquiry_type_display }}
                                        </span>
                                    </td>
                                    <td>{{ inquiry.created_at|date:"m/d" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="text-center">
                        <a href="{% url 'inquiries_list' %}" class="btn btn-sm btn-outline-primary">
                            전체 문의 보기 <i class="bi bi-arrow-right"></i>
                        </a>
                    </div>
                {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-chat-left" style="font-size: 2rem;"></i>
                        <p class="mt-2">등록된 문의가 없습니다.</p>
                        <small class="text-muted">고객 문의가 접수되면 여기에 표시됩니다.</small>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- 급여 기록 입력 모달 -->
<div class="modal fade" id="workRecordModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-cash me-2"></i>급여 기록 입력</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="workRecordForm" method="post" action="{% url 'work_record_create' %}">
                <div class="modal-body">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="staff_select" class="form-label">직원 선택</label>
                        <select class="form-select" name="staff" id="staff_select" required>
                            <option value="">직원을 선택하세요</option>
                            {% for staff in staff_list %}
                            <option value="{{ staff.id }}">{{ staff.name }} ({{ staff.nickname }}) - {{ staff.get_employee_type_display }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="total_hours" class="form-label">총 근무시간</label>
                            <input type="number" class="form-control" name="total_hours" id="dashboard_total_hours" 
                                   step="0.1" min="0" placeholder="160.0" required>
                            <small class="text-muted">시간 단위로 입력</small>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="pay_period_weeks" class="form-label">급여 기간(주)</label>
                            <input type="number" class="form-control" name="pay_period_weeks" id="dashboard_pay_period_weeks" 
                                   step="0.1" min="0.1" value="4.0" placeholder="4.0" required>
                            <small class="text-muted">주 단위로 입력</small>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="hourly_rate" class="form-label">시급</label>
                            <div class="input-group">
                                <input type="text" class="form-control money-input" name="hourly_rate" id="dashboard_hourly_rate" 
                                       placeholder="10,000" required>
                                <span class="input-group-text">원</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="monthly_salary" class="form-label">월급 <small class="text-primary">(자동계산)</small></label>
                            <div class="input-group">
                                <input type="text" class="form-control bg-light money-input" name="monthly_salary" id="dashboard_monthly_salary" 
                                       placeholder="자동 계산됩니다" readonly>
                                <span class="input-group-text">원</span>
                            </div>
                            <small class="text-muted">시급과 총근무시간으로 자동 계산됩니다</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="weekly_holiday_allowance" class="form-label">주휴수당 <small class="text-primary">(자동계산)</small></label>
                            <div class="input-group">
                                <input type="text" class="form-control bg-light money-input" name="weekly_holiday_allowance" id="dashboard_weekly_holiday_allowance" 
                                       placeholder="자동 계산됩니다" readonly>
                                <span class="input-group-text">원</span>
                            </div>
                            <small class="text-muted">주 15시간 이상 근무 시 법정 기준으로 자동 계산됩니다</small>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="memo" class="form-label">비고 (선택사항)</label>
                        <textarea class="form-control" name="memo" id="memo" rows="2" 
                                  placeholder="특이사항이 있으면 입력하세요"></textarea>
                    </div>
                    
                    <div class="alert alert-info">
                        <small><i class="bi bi-info-circle me-1"></i>월급과 주휴수당이 자동으로 계산됩니다</small>
                        <br><small>• 월급: 시급 × 총근무시간</small>
                        <br><small>• 주휴수당: 주 15시간 이상 근무 시 법정 기준으로 자동 계산</small>
                        <br><strong>• 예상 지급합계: <span id="dashboard_total_payment_display" class="text-primary">0원</span></strong>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="submit" class="btn btn-primary">저장</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function calculateDashboardSalary() {
    const totalHours = parseFloat(document.getElementById('dashboard_total_hours').value) || 0;
    const payPeriodWeeks = parseFloat(document.getElementById('dashboard_pay_period_weeks').value) || 1;
    
    // 콤마가 포함된 시급에서 숫자만 추출
    const hourlyRateElement = document.getElementById('dashboard_hourly_rate');
    const hourlyRate = parseFloat(removeCommas(hourlyRateElement.value)) || 0;
    
    const monthlySalary = totalHours * hourlyRate;
    
    // 주휴수당 계산 (정확한 주별 근무시간 사용)
    const weeklyHours = totalHours / payPeriodWeeks;
    let weeklyHolidayAllowance = 0;
    
    if (weeklyHours >= 15) {  // 주 15시간 이상 근무 시 주휴수당 지급
        if (weeklyHours < 40) {
            // 주 40시간 미만: (1주 소정근로시간 / 40) * 8 * 시급
            weeklyHolidayAllowance = (weeklyHours / 40) * 8 * hourlyRate;
        } else {
            // 주 40시간 이상: 1일 소정근로시간(최대 8시간) * 시급
            weeklyHolidayAllowance = 8 * hourlyRate;
        }
    }
    
    // 계산된 값을 콤마 포맷팅하여 표시
    document.getElementById('dashboard_monthly_salary').value = formatKoreanWon(Math.round(monthlySalary));
    document.getElementById('dashboard_weekly_holiday_allowance').value = formatKoreanWon(Math.round(weeklyHolidayAllowance));
    
    // 지급합계도 업데이트 (실시간 표시용)
    const totalPayment = monthlySalary + weeklyHolidayAllowance;
    const totalPaymentElement = document.getElementById('dashboard_total_payment_display');
    if (totalPaymentElement) {
        totalPaymentElement.textContent = formatKoreanWon(Math.round(totalPayment)) + '원';
    }
}

// 페이지 로드 시 대시보드 이벤트 리스너 추가
document.addEventListener('DOMContentLoaded', function() {
    const dashboardTotalHours = document.getElementById('dashboard_total_hours');
    const dashboardPayPeriodWeeks = document.getElementById('dashboard_pay_period_weeks');
    const dashboardHourlyRate = document.getElementById('dashboard_hourly_rate');
    
    // 입력 필드에 이벤트 리스너 추가
    if (dashboardTotalHours) {
        dashboardTotalHours.addEventListener('input', calculateDashboardSalary);
        dashboardTotalHours.addEventListener('change', calculateDashboardSalary);
    }
    
    if (dashboardPayPeriodWeeks) {
        dashboardPayPeriodWeeks.addEventListener('input', calculateDashboardSalary);
        dashboardPayPeriodWeeks.addEventListener('change', calculateDashboardSalary);
    }
    
    if (dashboardHourlyRate) {
        dashboardHourlyRate.addEventListener('input', calculateDashboardSalary);
        dashboardHourlyRate.addEventListener('change', calculateDashboardSalary);
        dashboardHourlyRate.addEventListener('blur', calculateDashboardSalary);
    }
    
    // 페이지 로드 시 초기 계산
    calculateDashboardSalary();
});

// Chart.js 스크립트
const chartData = {{ chart_data|safe }};

// 월별 매출 트렌드 차트
const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
const monthlyChart = new Chart(monthlyCtx, {
    type: 'line',
    data: {
        labels: chartData.monthly.labels,
        datasets: [{
            label: '매출',
            data: chartData.monthly.sales,
            borderColor: 'rgb(54, 162, 235)',
            backgroundColor: 'rgba(54, 162, 235, 0.1)',
            tension: 0.4,
            fill: true
        }, {
            label: '원가',
            data: chartData.monthly.costs,
            borderColor: 'rgb(255, 99, 132)',
            backgroundColor: 'rgba(255, 99, 132, 0.1)',
            tension: 0.4,
            fill: false
        }, {
            label: '수익',
            data: chartData.monthly.profits,
            borderColor: 'rgb(75, 192, 192)',
            backgroundColor: 'rgba(75, 192, 192, 0.1)',
            tension: 0.4,
            fill: false
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return value.toLocaleString() + '원';
                    }
                }
            }
        },
        plugins: {
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return context.dataset.label + ': ' + context.parsed.y.toLocaleString() + '원';
                    }
                }
            }
        }
    }
});

// 일별 매출 차트
const dailyCtx = document.getElementById('dailyChart').getContext('2d');
const dailyChart = new Chart(dailyCtx, {
    type: 'bar',
    data: {
        labels: chartData.daily.labels,
        datasets: [{
            label: '일별 매출',
            data: chartData.daily.sales,
            backgroundColor: 'rgba(54, 162, 235, 0.6)',
            borderColor: 'rgb(54, 162, 235)',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return value.toLocaleString() + '원';
                    }
                }
            }
        },
        plugins: {
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return context.parsed.y.toLocaleString() + '원';
                    }
                }
            }
        }
    }
});

// 매출 구성 도넛 차트
const compositionCtx = document.getElementById('salesCompositionChart').getContext('2d');
const salesAnalysis = {
    current_month: {{ sales_analysis.current_month }},
    current_cost: {{ sales_analysis.current_cost }},
    current_profit: {{ sales_analysis.current_profit }}
};

const compositionChart = new Chart(compositionCtx, {
    type: 'doughnut',
    data: {
        labels: ['원가', '수익'],
        datasets: [{
            data: [salesAnalysis.current_cost, salesAnalysis.current_profit],
            backgroundColor: [
                'rgba(255, 99, 132, 0.8)',
                'rgba(75, 192, 192, 0.8)'
            ],
            borderColor: [
                'rgb(255, 99, 132)',
                'rgb(75, 192, 192)'
            ],
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                        const percentage = ((context.parsed / total) * 100).toFixed(1);
                        return context.label + ': ' + context.parsed.toLocaleString() + '원 (' + percentage + '%)';
                    }
                }
            }
        }
    }
});

</script>
{% endblock %}