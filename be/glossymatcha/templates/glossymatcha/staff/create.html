{% extends 'glossymatcha/base.html' %}

{% block title %}
    {% if staff %}직원 정보 수정{% else %}직원 등록{% endif %} - Glossy Matcha
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-person-plus me-2"></i>
                    {% if staff %}{{ staff.name }} 정보 수정{% else %}새 직원 등록{% endif %}
                </h5>
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.name.id_for_label }}" class="form-label">직원명 *</label>
                            {{ form.name }}
                            {% if form.name.errors %}
                                <div class="text-danger small">{{ form.name.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.nickname.id_for_label }}" class="form-label">직원 닉네임</label>
                            {{ form.nickname }}
                            {% if form.nickname.errors %}
                                <div class="text-danger small">{{ form.nickname.errors.0 }}</div>
                            {% endif %}
                            <small class="text-muted">ex) jack, ash, jenny</small>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.employee_type.id_for_label }}" class="form-label">근무 형태 *</label>
                            {{ form.employee_type }}
                            {% if form.employee_type.errors %}
                                <div class="text-danger small">{{ form.employee_type.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.resident_number.id_for_label }}" class="form-label">주민번호 *</label>
                            {{ form.resident_number }}
                            {% if form.resident_number.errors %}
                                <div class="text-danger small">{{ form.resident_number.errors.0 }}</div>
                            {% endif %}
                            <small class="text-muted">13자리 숫자만 입력 (하이픈 없이)</small>
                            <div id="resident-error" class="text-danger small" style="display: none;"></div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.hire_date.id_for_label }}" class="form-label">입사일 *</label>
                            {{ form.hire_date }}
                            {% if form.hire_date.errors %}
                                <div class="text-danger small">{{ form.hire_date.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.resignation_date.id_for_label }}" class="form-label">퇴사일</label>
                            {{ form.resignation_date }}
                            {% if form.resignation_date.errors %}
                                <div class="text-danger small">{{ form.resignation_date.errors.0 }}</div>
                            {% endif %}
                            <small class="text-muted">재직 중인 경우 비워두세요</small>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.contact.id_for_label }}" class="form-label">연락처 *</label>
                            {{ form.contact }}
                            {% if form.contact.errors %}
                                <div class="text-danger small">{{ form.contact.errors.0 }}</div>
                            {% endif %}
                            <small class="text-muted">010으로 시작하는 11자리 숫자 (하이픈 없이)</small>
                            <div id="contact-error" class="text-danger small" style="display: none;"></div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.memo.id_for_label }}" class="form-label">비고</label>
                            {{ form.memo }}
                            {% if form.memo.errors %}
                                <div class="text-danger small">{{ form.memo.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {{ form.non_field_errors }}
                        </div>
                    {% endif %}
                    
                    <div class="d-flex justify-content-between">
                        <a href="{% url 'staff_list' %}" class="btn btn-secondary">
                            <i class="bi bi-arrow-left me-2"></i>목록으로
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-lg me-2"></i>
                            {% if staff %}수정하기{% else %}등록하기{% endif %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const contactField = document.getElementById('{{ form.contact.id_for_label }}');
    const contactError = document.getElementById('contact-error');
    const residentField = document.getElementById('{{ form.resident_number.id_for_label }}');
    const residentError = document.getElementById('resident-error');
    
    function validateContact() {
        const contact = contactField.value.replace(/[^0-9]/g, ''); // 숫자만 추출
        contactError.style.display = 'none';
        contactField.classList.remove('is-invalid');
        
        if (contact && contact.length > 0) {
            if (contact.length !== 11) {
                contactError.textContent = '연락처는 11자리 숫자여야 합니다.';
                contactError.style.display = 'block';
                contactField.classList.add('is-invalid');
                return false;
            }
            
            if (!contact.startsWith('010')) {
                contactError.textContent = '연락처는 010으로 시작해야 합니다.';
                contactError.style.display = 'block';
                contactField.classList.add('is-invalid');
                return false;
            }
            
            // 유효한 경우 숫자만 필드에 설정
            contactField.value = contact;
            contactField.classList.add('is-valid');
        }
        
        return true;
    }
    
    function validateResidentNumber() {
        const resident = residentField.value.replace(/[^0-9]/g, ''); // 숫자만 추출
        residentError.style.display = 'none';
        residentField.classList.remove('is-invalid');
        
        if (resident && resident.length > 0) {
            if (resident.length !== 13) {
                residentError.textContent = '주민번호는 13자리 숫자여야 합니다.';
                residentError.style.display = 'block';
                residentField.classList.add('is-invalid');
                return false;
            }
            
            // 유효한 경우 숫자만 필드에 설정
            residentField.value = resident;
            residentField.classList.add('is-valid');
        }
        
        return true;
    }
    
    // 연락처 입력 시 실시간 검증
    contactField.addEventListener('input', function() {
        // 숫자만 입력 허용
        this.value = this.value.replace(/[^0-9]/g, '');
        
        // 11자리 제한
        if (this.value.length > 11) {
            this.value = this.value.substring(0, 11);
        }
        
        validateContact();
    });
    
    // 주민번호 입력 시 실시간 검증
    residentField.addEventListener('input', function() {
        // 숫자만 입력 허용
        this.value = this.value.replace(/[^0-9]/g, '');
        
        // 13자리 제한
        if (this.value.length > 13) {
            this.value = this.value.substring(0, 13);
        }
        
        validateResidentNumber();
    });
    
    // 폼 제출 전 검증
    document.querySelector('form').addEventListener('submit', function(e) {
        const isContactValid = validateContact();
        const isResidentValid = validateResidentNumber();
        
        if (!isContactValid) {
            e.preventDefault();
            contactField.focus();
        } else if (!isResidentValid) {
            e.preventDefault();
            residentField.focus();
        }
    });
    
    // 페이지 로드시 검증
    if (contactField.value) {
        validateContact();
    }
    if (residentField.value) {
        validateResidentNumber();
    }
});
</script>
{% endblock %}